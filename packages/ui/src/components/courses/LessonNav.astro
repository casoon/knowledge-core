---
export interface Lesson {
  slug: string;
  data: {
    title: string;
    module: string;
    orderInModule: number;
    estimatedMinutes: number;
  };
}

export interface Props {
  courseTitle: string;
  courseSlug: string;
  lessons: Lesson[];
  currentLessonSlug: string;
  lessonsByModule: Record<string, Lesson[]>;
}

const { courseTitle, courseSlug, lessons, currentLessonSlug, lessonsByModule } =
  Astro.props;

const currentIndex = lessons.findIndex((l) => l.slug === currentLessonSlug);
const progress = Math.round(((currentIndex + 1) / lessons.length) * 100);
---

<div id="lesson-nav" class="lesson-nav">
  <button
    id="lesson-nav-toggle"
    class="lesson-nav-toggle"
    aria-label="Kursnavigation ein-/ausblenden"
    aria-expanded="false"
  >
    <svg
      class="toggle-icon"
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      <path d="M15 18l-6-6 6-6"></path>
    </svg>
  </button>
  <div class="lesson-nav-panel">
    <div class="lesson-nav-header">
      <a
        href={`/courses/${courseSlug}`}
        class="course-title"
        title="Zur KursÃ¼bersicht"
      >
        {courseTitle}
      </a>
      <div class="progress-info">
        <span class="progress-text"
          >{currentIndex + 1} von {lessons.length} Lektionen</span
        >
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style={`width: ${progress}%`}></div>
        </div>
      </div>
    </div>

    <nav class="lesson-nav-content">
      {
        Object.entries(lessonsByModule).map(([module, moduleLessons]) => (
          <div class="module-group">
            <h4 class="module-title">{module}</h4>
            <ul class="lesson-list">
              {moduleLessons.map((lesson, idx) => {
                const isActive = lesson.slug === currentLessonSlug;
                const lessonIndex = lessons.findIndex(
                  (l) => l.slug === lesson.slug
                );
                const isCompleted = lessonIndex < currentIndex;
                return (
                  <li>
                    <a
                      href={`/courses/${courseSlug}/${lesson.slug}`}
                      class:list={[
                        'lesson-link',
                        { active: isActive },
                        { completed: isCompleted },
                      ]}
                      aria-current={isActive ? 'page' : undefined}
                    >
                      <span class="lesson-number">
                        {isCompleted ? (
                          <svg
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="3"
                          >
                            <polyline points="20 6 9 17 4 12" />
                          </svg>
                        ) : (
                          idx + 1
                        )}
                      </span>
                      <span class="lesson-title">{lesson.data.title}</span>
                      <span class="lesson-time">
                        {lesson.data.estimatedMinutes}m
                      </span>
                    </a>
                  </li>
                );
              })}
            </ul>
          </div>
        ))
      }
    </nav>
  </div>
</div>

<style>
  .lesson-nav {
    position: fixed;
    right: 0;
    top: 4rem;
    height: calc(100vh - 4rem);
    z-index: 40;
    display: flex;
    align-items: flex-start;
    transform: translateX(320px);
    transition: transform 0.3s ease;
  }

  .lesson-nav.open {
    transform: translateX(0);
  }

  .lesson-nav-toggle {
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    margin-top: 1rem;
    background: hsl(var(--color-surface));
    border: 1px solid hsl(var(--color-border));
    border-right: none;
    border-radius: 0.5rem 0 0 0.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: hsl(var(--color-text-muted));
    transition: background 0.2s ease, color 0.2s ease;
  }

  .lesson-nav-toggle:hover {
    background: hsl(var(--color-surface-alt));
    color: hsl(var(--color-text));
  }

  .toggle-icon {
    transition: transform 0.3s ease;
  }

  .lesson-nav.open .toggle-icon {
    transform: rotate(180deg);
  }

  .lesson-nav-panel {
    width: 320px;
    height: 100%;
    background: hsl(var(--color-surface));
    border-left: 1px solid hsl(var(--color-border));
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .lesson-nav-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid hsl(var(--color-border));
    background: hsl(var(--color-surface-alt));
  }

  .course-title {
    display: block;
    font-weight: 600;
    color: hsl(var(--color-text));
    text-decoration: none;
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
  }

  .course-title:hover {
    color: hsl(var(--color-primary));
  }

  .progress-info {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .progress-text {
    font-size: 0.75rem;
    color: hsl(var(--color-text-muted));
  }

  .progress-bar-container {
    height: 4px;
    background: hsl(var(--color-border));
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: hsl(var(--color-primary));
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  .lesson-nav-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 0;
  }

  .module-group {
    margin-bottom: 1.25rem;
  }

  .module-title {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: hsl(var(--color-text-muted));
    padding: 0 1.25rem;
    margin-bottom: 0.5rem;
  }

  .lesson-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .lesson-link {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.5rem 1.25rem;
    text-decoration: none;
    color: hsl(var(--color-text));
    font-size: 0.85rem;
    transition: all 0.15s ease;
    border-left: 3px solid transparent;
  }

  .lesson-link:hover {
    background: hsl(var(--color-surface-alt));
  }

  .lesson-link.active {
    background: hsl(var(--color-primary) / 0.1);
    border-left-color: hsl(var(--color-primary));
    color: hsl(var(--color-primary));
  }

  .lesson-link.completed .lesson-number {
    background: hsl(var(--color-success));
    color: white;
  }

  .lesson-number {
    flex-shrink: 0;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    background: hsl(var(--color-border));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    color: hsl(var(--color-text-muted));
  }

  .lesson-link.active .lesson-number {
    background: hsl(var(--color-primary));
    color: white;
  }

  .lesson-title {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .lesson-time {
    flex-shrink: 0;
    font-size: 0.7rem;
    color: hsl(var(--color-text-muted));
  }

  /* Mobile: komplett versteckt */
  @media (max-width: 1023px) {
    .lesson-nav {
      display: none;
    }
  }
</style>

<script is:inline>
  (function() {
    function safeGetItem(key) {
      try {
        return localStorage.getItem(key);
      } catch {
        return null;
      }
    }

    function safeSetItem(key, value) {
      try {
        localStorage.setItem(key, value);
      } catch {}
    }

    const nav = document.getElementById('lesson-nav');
    const toggle = document.getElementById('lesson-nav-toggle');

    if (!nav || !toggle) return;

    // Load state from localStorage
    const isOpen = safeGetItem('lessonNavOpen') === 'true';
    if (isOpen) {
      nav.classList.add('open');
      toggle.setAttribute('aria-expanded', 'true');
    }

    toggle.addEventListener('click', () => {
      const nowOpen = nav.classList.toggle('open');
      toggle.setAttribute('aria-expanded', String(nowOpen));
      safeSetItem('lessonNavOpen', String(nowOpen));
    });

    // Scroll active lesson into view
    const activeLink = nav.querySelector('.lesson-link.active');
    if (activeLink) {
      setTimeout(() => {
        activeLink.scrollIntoView({ block: 'center', behavior: 'smooth' });
      }, 100);
    }
  })();
</script>
