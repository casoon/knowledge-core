---
export interface Course {
  slug: string;
  title: string;
  lessonCount: number;
}

export interface Props {
  courses: Course[];
}

const { courses } = Astro.props;
const totalLessons = courses.reduce((sum, c) => sum + c.lessonCount, 0);
---

<div class="total-progress" data-total-progress data-courses={JSON.stringify(courses)} data-total-lessons={totalLessons}>
  <div class="flex items-center justify-between mb-3">
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      <span class="font-semibold text-text">Dein Gesamtfortschritt</span>
    </div>
    <span class="text-sm text-text-muted" data-progress-label>Wird geladen...</span>
  </div>

  <div class="w-full h-4 bg-surface-alt rounded-full overflow-hidden">
    <div
      class="h-full bg-gradient-to-r from-primary to-primary-hover transition-all duration-500"
      style="width: 0%"
      role="progressbar"
      aria-valuenow="0"
      aria-valuemin="0"
      aria-valuemax={totalLessons}
      data-progress-bar
    >
    </div>
  </div>

  <div class="mt-3 flex flex-wrap gap-2" data-course-pills>
    {courses.map((course) => (
      <a
        href={`/courses/${course.slug}`}
        class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs rounded-full bg-surface border border-border hover:border-primary hover:text-primary transition-colors"
        data-course-pill={course.slug}
      >
        <span class="w-2 h-2 rounded-full bg-border" data-course-dot></span>
        <span>{course.title}</span>
        <span class="text-text-muted" data-course-progress>0%</span>
      </a>
    ))}
  </div>
</div>

<script>
  import { safeGetItem } from '../../scripts/storage';

  function initTotalProgress(): void {
    const container = document.querySelector('[data-total-progress]');
    if (!container) return;

    const coursesData = container.getAttribute('data-courses');
    const totalLessons = parseInt(container.getAttribute('data-total-lessons') || '0', 10);

    if (!coursesData || totalLessons === 0) return;

    const courses = JSON.parse(coursesData) as Array<{ slug: string; title: string; lessonCount: number }>;

    let completedTotal = 0;

    courses.forEach((course) => {
      const progressKey = `course-progress-${course.slug}`;
      const progressData = safeGetItem(progressKey);

      let completed = 0;
      if (progressData) {
        try {
          const parsed = JSON.parse(progressData);
          completed = Array.isArray(parsed) ? parsed.length : 0;
        } catch {
          completed = 0;
        }
      }

      completedTotal += completed;
      const coursePercent = course.lessonCount > 0
        ? Math.round((completed / course.lessonCount) * 100)
        : 0;

      // Update course pill
      const pill = container.querySelector(`[data-course-pill="${course.slug}"]`);
      if (pill) {
        const dot = pill.querySelector('[data-course-dot]') as HTMLElement;
        const progressSpan = pill.querySelector('[data-course-progress]');

        if (progressSpan) {
          progressSpan.textContent = `${coursePercent}%`;
        }

        if (dot) {
          if (coursePercent === 100) {
            dot.classList.remove('bg-border', 'bg-primary');
            dot.classList.add('bg-success');
          } else if (coursePercent > 0) {
            dot.classList.remove('bg-border', 'bg-success');
            dot.classList.add('bg-primary');
          }
        }
      }
    });

    // Update total progress bar
    const totalPercent = totalLessons > 0
      ? Math.round((completedTotal / totalLessons) * 100)
      : 0;

    const progressBar = container.querySelector('[data-progress-bar]') as HTMLElement;
    const progressLabel = container.querySelector('[data-progress-label]');

    if (progressBar) {
      progressBar.style.width = `${totalPercent}%`;
      progressBar.setAttribute('aria-valuenow', String(completedTotal));
    }

    if (progressLabel) {
      progressLabel.textContent = `${completedTotal} / ${totalLessons} Lektionen (${totalPercent}%)`;
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTotalProgress);
  } else {
    initTotalProgress();
  }
</script>
